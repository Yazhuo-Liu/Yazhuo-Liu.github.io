<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>My Songs | Yazhuo Liu</title>

  <link rel="canonical" href="https://yazhuoliu.com/assets/htmls/music.html" />

  <link href="../../assets/img/yazhuo-liu-profile.webp" rel="icon">
  <link href="../../assets/img/yazhuo-liu-profile.webp" rel="apple-touch-icon">

  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
  <link href="../../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../../assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="../../assets/css/style.css" rel="stylesheet">

  <style>
    #main { padding: 40px 30px; min-height: 100vh; background: linear-gradient(180deg, #f8fbfd 0%, #fff 120px); }
    .music-content { background: #fff; padding: 40px 36px; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); max-width: 960px; margin: 0 auto; }
    .music-content .section-title { margin-bottom: 32px; }
    .music-content .section-title h2 { font-size: 28px; color: #173b6c; margin-bottom: 8px; }
    .music-content .section-title p { color: #6c757d; font-size: 0.95rem; line-height: 1.6; margin-top: 4px; }
    .song-card { cursor: pointer; border: 1px solid #e8eef2; border-radius: 10px; padding: 20px 22px; margin-bottom: 14px; transition: all 0.25s ease; background: #fff; }
    .song-card:hover { border-color: #149ddd; background: linear-gradient(135deg, #fafcff 0%, #f0f8ff 100%); box-shadow: 0 6px 20px rgba(20,157,221,0.12); transform: translateY(-2px); }
    .song-card h5 { margin: 0 0 8px 0; color: #173b6c; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.02em; }
    .song-card .description { font-size: 0.9rem; color: #5a6c7d; margin: 0; line-height: 1.5; }
    .player-section { margin-top: 32px; padding-top: 28px; border-top: 1px solid #e8eef2; }
    .player-section .current-title { font-size: 1.35rem; color: #173b6c; margin-bottom: 20px; font-weight: 600; }
    .story-section { margin-top: 0; margin-bottom: 0; padding: 20px 22px; background: #f8fbfd; border-radius: 10px; border-left: 4px solid #149ddd; font-size: 0.95rem; line-height: 1.75; color: #374151; clear: both; }
    .story-section .story-section-title { margin: 0 0 0.75em 0; font-size: 1.05rem; font-weight: 600; color: #173b6c; }
    .story-section h1, .story-section h2, .story-section h3 { font-size: 1rem; margin-top: 1em; margin-bottom: 0.4em; color: #173b6c; }
    .story-section p { margin-bottom: 0.6em; }
    .story-section p:last-child { margin-bottom: 0; }
    .story-placeholder { color: #94a3b8; font-style: italic; }
    .lyrics-box { max-height: 360px; overflow-y: auto; padding: 20px; margin-bottom: 24px; background: #f8fbfd; border-radius: 10px; font-size: 1.05rem; line-height: 1.85; white-space: pre-wrap; border: 1px solid #e8eef2; }
    .lyrics-box .lrc-line { padding: 4px 0; transition: color 0.15s, font-weight 0.15s; }
    .lyrics-box .lrc-line.active { color: #149ddd; font-weight: 600; }
    .audio-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .audio-controls audio { flex: 1; min-width: 200px; height: 40px; }
    .back-to-list { margin-bottom: 20px; }
    .back-to-list .btn { font-size: 0.9rem; }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PR8K6WLC14"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PR8K6WLC14');
  </script>

</head>

<body>

  <i class="bi bi-list mobile-nav-toggle d-xl-none"></i>

  <header id="header">
    <div class="d-flex flex-column">
      <div class="profile">
        <img src="../../assets/img/yazhuo-liu-profile.webp" alt="" class="img-fluid rounded-circle">
        <h1 class="text-light"><a href="../../index.html">Yazhuo Liu</a></h1>
        <div class="social-links mt-3 text-center">
          <a href="https://www.linkedin.com/in/yazhuo-liu-321b45226/" class="linkedin"><i class="bx bxl-linkedin"></i></a>
          <a href="https://github.com/Yazhuo-Liu" class="github"><i class="bx bxl-github"></i></a>
          <a href="https://www.facebook.com/yazhuo.liu.758" class="facebook"><i class="bx bxl-facebook"></i></a>
          <a href="https://www.instagram.com/yazhuo_liu/" class="instagram"><i class="bx bxl-instagram"></i></a>
          <a href="https://orcid.org/0000-0003-1160-1779" class="orcid"><i class="bx bxs-graduation"></i></a>
        </div>
      </div>
      <nav id="navbar" class="nav-menu navbar">
        <ul>
          <li><a href="../../index.html#hero" class="nav-link"><i class="bx bx-home"></i> <span>Home</span></a></li>
          <li><a href="../../index.html#about" class="nav-link"><i class="bx bx-user"></i> <span>About</span></a></li>
          <li><a href="../../index.html#resume" class="nav-link"><i class="bx bx-file-blank"></i> <span>Resume</span></a></li>
          <li><a href="../../index.html#portfolio" class="nav-link"><i class="bx bx-book-content"></i> <span>Gallery</span></a></li>
          <li><a href="../../index.html#writings" class="nav-link"><i class="bx bx-pen"></i> <span>Writings & Blogs</span></a></li>
          <li><a href="../../assets/htmls/music.html" class="nav-link active"><i class="bx bx-music"></i> <span>My Songs</span></a></li>
          <li><a href="../../index.html#contact" class="nav-link"><i class="bx bx-envelope"></i> <span>Contact</span></a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main id="main">
    <div class="container-fluid music-content">
      <div class="back-to-list">
        <a href="../../index.html#writings" class="btn btn-sm btn-outline-primary rounded-pill"><i class="bi bi-arrow-left"></i> Back to Home</a>
      </div>

      <div class="section-title">
        <h2>My Songs</h2>
        <p>I weave the narratives while AI sculpts the sound.</p>
        <p>My lyrics are the heartbeat, eventually finding their pulse in digital harmonies.</p>
      </div>

      <div id="song-list" class="row"></div>

      <div id="player-section" class="player-section" style="display: none;">
        <h4 id="current-title" class="current-title"></h4>
        <div class="audio-controls">
          <audio id="audio" controls preload="metadata"></audio>
        </div>
        <div id="lyrics-box" class="lyrics-box"></div>
        <div id="story-section" class="story-section" style="display: none;"></div>
      </div>
    </div>
  </main>

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <script src="../../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../../assets/js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // Song list is loaded from assets/music/SongsList.json
    let SONGS = [];

    const songListEl = document.getElementById('song-list');
    const playerSection = document.getElementById('player-section');
    const currentTitleEl = document.getElementById('current-title');
    const storySectionEl = document.getElementById('story-section');
    const audioEl = document.getElementById('audio');
    const lyricsBox = document.getElementById('lyrics-box');

    function pathFromHtml(base) {
      if (!base) return '';
      if (base.startsWith('http') || base.startsWith('/')) return base;
      return '../../' + base.replace(/^\//, '');
    }

    function renderList() {
      if (SONGS.length === 0) {
        songListEl.innerHTML = '<div class="col-12"><p class="text-muted">No songs yet. Add entries to <code>assets/music/SongsList.json</code>, and place audio and lyrics files in the <code>assets/music/</code> directory. See <code>assets/music/README.md</code> for details.</p></div>';
        return;
      }
      songListEl.innerHTML = SONGS.map((s, i) => `
        <div class="col-lg-4 col-md-6 mb-3">
          <div class="song-card" data-index="${i}">
            <h5>${escapeHtml(s.title)}</h5>
            ${s.description ? '<p class="description">' + escapeHtml(s.description) + '</p>' : ''}
          </div>
        </div>
      `).join('');
      songListEl.querySelectorAll('.song-card').forEach(card => {
        card.addEventListener('click', () => playSong(card.dataset.index));
      });
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function parseLrc(text) {
      const lines = text.split(/\r?\n/);
      const result = [];
      const regex = /^\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]\s*(.*)$/;
      for (const line of lines) {
        const m = line.match(regex);
        if (m) {
          const min = parseInt(m[1], 10);
          const sec = parseInt(m[2], 10);
          const ms = (m[3] || '0').padEnd(3, '0').slice(0, 3);
          const time = min * 60 + sec + parseInt(ms, 10) / 1000;
          result.push({ time, text: m[4].trim() });
        }
      }
      result.sort((a, b) => a.time - b.time);
      return result;
    }

    let lrcLines = [];
    let currentLineIndex = -1;

    function updateLrcHighlight(currentTime) {
      if (lrcLines.length === 0) return;
      let idx = -1;
      for (let i = lrcLines.length - 1; i >= 0; i--) {
        if (currentTime >= lrcLines[i].time) { idx = i; break; }
      }
      if (idx === currentLineIndex) return;
      currentLineIndex = idx;
      const nodes = lyricsBox.querySelectorAll('.lrc-line');
      nodes.forEach((n, i) => n.classList.toggle('active', i === idx));
      
      if (idx >= 0 && nodes[idx]) {
        const line = nodes[idx];
        const lineH = line.offsetHeight;
        const boxH = lyricsBox.clientHeight;
        const boxRect = lyricsBox.getBoundingClientRect();
        const lineRect = line.getBoundingClientRect();
        const lineTopInContent = lyricsBox.scrollTop + (lineRect.top - boxRect.top);
        const targetTop = lineTopInContent - (boxH / 2) + (lineH / 2);
        const maxScroll = lyricsBox.scrollHeight - boxH;
        lyricsBox.scrollTo({ top: Math.max(0, Math.min(targetTop, maxScroll)), behavior: 'smooth' });
      }
    }

    async function loadLyrics(url) {
      if (!url) return null;
      const fullUrl = pathFromHtml(url);
      try {
        const res = await fetch(fullUrl);
        if (!res.ok) return null;
        return await res.text();
      } catch (e) {
        return null;
      }
    }

    /** Story URL: same path as audio, extension .md (e.g. assets/music/歌名.mp3 -> assets/music/歌名.md) */
    function storyUrlForSong(song) {
      if (!song || !song.audio) return null;
      const base = song.audio.replace(/\.[^.]+$/, '');
      return base + '.md';
    }

    async function loadStory(song) {
      const url = storyUrlForSong(song);
      if (!url) return null;
      const fullUrl = pathFromHtml(url);
      try {
        const res = await fetch(fullUrl);
        if (!res.ok) return null;
        return await res.text();
      } catch (e) {
        return null;
      }
    }

    function showStory(song, rawMarkdown) {
      if (!rawMarkdown || !rawMarkdown.trim()) {
        storySectionEl.style.display = 'none';
        storySectionEl.innerHTML = '';
        return;
      }
      storySectionEl.style.display = 'block';
      const titleHtml = '<h5 class="story-section-title">创作手记</h5>';
      if (typeof marked !== 'undefined') {
        storySectionEl.innerHTML = titleHtml + marked.parse(rawMarkdown.trim());
      } else {
        storySectionEl.innerHTML = titleHtml + '<div>' + escapeHtml(rawMarkdown.trim()) + '</div>';
      }
    }

    function showStoryPlaceholder(song) {
      const baseName = song.audio ? song.audio.replace(/\.[^.]+$/, '').split('/').pop() : song.title;
      storySectionEl.style.display = 'block';
      storySectionEl.innerHTML = '<h5 class="story-section-title">创作手记</h5><p class="story-placeholder">暂无歌词背后的故事。可在 <code>assets/music/' + escapeHtml(baseName) + '.md</code> 中撰写。</p>';
    }

    function showLyrics(song, text) {
      lyricsBox.innerHTML = '';
      if (!text || !text.trim()) {
        lyricsBox.textContent = 'No lyrics';
        lrcLines = [];
        return;
      }
      const isLrc = song.lyrics && song.lyrics.toLowerCase().endsWith('.lrc');
      if (isLrc) {
        lrcLines = parseLrc(text);
        lyricsBox.innerHTML = lrcLines.map(l => '<div class="lrc-line">' + escapeHtml(l.text) + '</div>').join('');
      } else {
        lrcLines = [];
        lyricsBox.textContent = text.trim();
      }
    }

    async function playSong(index) {
      const song = SONGS[Number(index)];
      if (!song || !song.audio) return;
      const audioUrl = pathFromHtml(song.audio);
      currentTitleEl.textContent = song.title;
      audioEl.src = audioUrl;
      playerSection.style.display = 'block';
      currentLineIndex = -1;
      lyricsBox.innerHTML = '<span class="text-muted">Loading lyrics…</span>';
      const rawLyrics = await loadLyrics(song.lyrics);
      showLyrics(song, rawLyrics);
      const rawStory = await loadStory(song);
      if (rawStory && rawStory.trim()) {
        showStory(song, rawStory);
      } else {
        showStoryPlaceholder(song);
      }
      audioEl.load();
      audioEl.play().catch(() => {});
    }

    audioEl.addEventListener('timeupdate', function () {
      if (lrcLines.length > 0) updateLrcHighlight(audioEl.currentTime);
    });

    async function init() {
      try {
        const res = await fetch(pathFromHtml('assets/music/SongsList.json'));
        if (res.ok) {
          const data = await res.json();
          const raw = Array.isArray(data) ? data : (data.songs || data.list || []);
          SONGS = raw.slice().reverse(); // newest first
        }
      } catch (e) {
        SONGS = [];
      }
      renderList();
      const hash = window.location.hash.replace(/^#/, '');
      if (hash) {
        const idx = parseInt(hash, 10);
        if (!isNaN(idx) && idx >= 0 && idx < SONGS.length) {
          await playSong(idx);
          audioEl.play().catch(() => {});
        }
      }
    }

    init();
  </script>

  <footer id="footer">
    <div class="container">
      <div class="copyright">&copy; Copyright <strong><span>Yazhuo Liu</span></strong>. All Rights Reserved</div>
      <div class="credits">Powered by <strong><span>GitHub Pages</span></strong></div>
    </div>
  </footer>

</body>
</html>
